import React, { useState } from 'react';
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  ComposedChart
} from 'recharts';
// Импорты иконок из lucide-react. Убедитесь, что они установлены.
import { Download, ChevronDown, ChevronRight, AlertTriangle, TrendingUp, Target, Clock, Filter } from 'lucide-react';
import * as XLSX from 'xlsx';
import { Analytics } from '../../types'; // Убедитесь, что путь к вашим типам верен

interface ChartsProps {
  analytics: Analytics;
}

const Charts: React.FC<ChartsProps> = ({ analytics }) => {
  const [activeAnalysis, setActiveAnalysis] = useState<'abc' | 'xyz' | 'abcxyz' | 'factor' | 'structural'>('abc');
  const [expandedStrategy, setExpandedStrategy] = useState<string | null>(null);
  const [abcxyzFilters, setAbcxyzFilters] = useState({
    abcCategory: '',
    xyzCategory: '',
    priority: '',
    combinedCategory: ''
  });

  const COLORS = ['#4A90E2', '#27AE60', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];

  // Вспомогательная функция для извлечения чистого текста из JSX-элементов
  const getPlainText = (jsxElements: (string | JSX.Element)[]): string => {
    return jsxElements.map(item => {
      if (typeof item === 'string') {
        return item;
      }
      // Если это ReactElement (например, <span>), пытаемся получить его children
      if (React.isValidElement(item) && item.props && item.props.children) {
        // Если children тоже ReactNode, рекурсивно вызываем getPlainText
        // В противном случае, если это просто строка, возвращаем её
        return typeof item.props.children === 'string'
          ? item.props.children
          : getPlainText(Array.isArray(item.props.children) ? item.props.children : [item.props.children]);
      }
      return ''; // Для других случаев или если children нет
    }).filter(Boolean).join('; '); // Фильтруем пустые строки и объединяем
  };


  const exportToExcel = () => {
    const wb = XLSX.utils.book_new();

    // Лист 1: Обзор по месяцам
    const monthlyData = analytics.monthlyTrend.map(item => ({
      'Месяц': item.month,
      'Количество продаж': item.sales,
      'Выручка (руб.)': item.revenue
    }));
    const monthlyWs = XLSX.utils.json_to_sheet(monthlyData);
    XLSX.utils.book_append_sheet(wb, monthlyWs, 'Обзор по месяцам');

    // Лист 2: ABC анализ
    const abcData = analytics.abcAnalysis.map(item => ({
      'Товар': item.product_name,
      'Выручка (руб.)': item.revenue,
      'Доля в выручке (%)': item.percentage.toFixed(1),
      'Накопительная доля (%)': item.cumulative_percentage.toFixed(1),
      'Категория': item.category
    }));
    const abcWs = XLSX.utils.json_to_sheet(abcData);
    XLSX.utils.book_append_sheet(wb, abcWs, 'ABC анализ');

    // Лист 3: XYZ анализ
    const xyzData = analytics.xyzAnalysis.map(item => ({
      'Товар': item.product_name,
      'Коэффициент вариации (%)': item.coefficient_variation.toFixed(1),
      'Категория': item.category,
      'Стабильность спроса': item.demand_stability
    }));
    const xyzWs = XLSX.utils.json_to_sheet(xyzData);
    XLSX.utils.book_append_sheet(wb, xyzWs, 'XYZ анализ');

    // Лист 4: ABC-XYZ анализ
    const abcxyzData = analytics.abcxyzAnalysis.map(item => ({
      'Товар': item.product_name,
      'ABC': item.abc_category,
      'XYZ': item.xyz_category,
      'Комбинированная категория': item.combined_category,
      'Стратегия': item.strategy,
      'Приоритет': item.priority,
      'Выручка (руб.)': item.revenue,
      'Коэффициент вариации (%)': item.coefficient_variation.toFixed(1)
    }));
    const abcxyzWs = XLSX.utils.json_to_sheet(abcxyzData);
    XLSX.utils.book_append_sheet(wb, abcxyzWs, 'ABC-XYZ анализ');

    // Лист 5: Подробный анализ
    const detailedData = analytics.abcxyzAnalysis.map(item => {
      const analysis = getStrategyAnalysis(
        item.combined_category,
        item.product_name, // product_name не используется в getStrategyAnalysis, но оставлен для полноты
        item.revenue,
        item.coefficient_variation
      );

      return {
        'Товар': item.product_name,
        'Категория': item.combined_category,
        'Приоритет': analysis.priority, // Использовать priority из analysis
        'Выручка (руб.)': item.revenue,
        'Коэффициент вариации (%)': item.coefficient_variation.toFixed(1),
        'Основные риски': getPlainText(analysis.risks),
        'Рекомендации': getPlainText(analysis.recommendations),
        'KPI для контроля': getPlainText(analysis.kpis)
      };
    });
    const detailedWs = XLSX.utils.json_to_sheet(detailedData);
    XLSX.utils.book_append_sheet(wb, detailedWs, 'Подробный анализ');

    // Факторный анализ
    const factorData = analytics.factorAnalysis.map(item => ({
      'Фактор': item.factor,
      'Влияние (%)': item.impact.toFixed(1),
      'Описание': item.description,
      'Тренд': item.trend === 'positive' ? 'Положительный' :
        item.trend === 'negative' ? 'Отрицательный' : 'Нейтральный'
    }));
    const factorWs = XLSX.utils.json_to_sheet(factorData);
    XLSX.utils.book_append_sheet(wb, factorWs, 'Факторный анализ');

    // Структурный анализ
    const structuralData = [
      ...analytics.structuralAnalysis.byCategory.map(item => ({
        'Тип': 'Категория',
        'Название': item.category,
        'Значение (руб.)': item.value,
        'Доля (%)': item.percentage.toFixed(1),
        'Изменение (%)': item.change.toFixed(1)
      })),
      ...analytics.structuralAnalysis.byRegion.map(item => ({
        'Тип': 'Регион',
        'Название': item.category,
        'Значение (руб.)': item.value,
        'Доля (%)': item.percentage.toFixed(1),
        'Изменение (%)': item.change.toFixed(1)
      })),
      ...analytics.structuralAnalysis.byChannel.map(item => ({
        'Тип': 'Канал',
        'Название': item.category,
        'Значение (руб.)': item.value,
        'Доля (%)': item.percentage.toFixed(1),
        'Изменение (%)': item.change.toFixed(1)
      }))
    ];
    const structuralWs = XLSX.utils.json_to_sheet(structuralData);
    XLSX.utils.book_append_sheet(wb, structuralWs, 'Структурный анализ');

    XLSX.writeFile(wb, `Анализ_Продаж_${new Date().toISOString().split('T')[0]}.xlsx`);
  };

  const getStrategyAnalysis = (combinedCategory: string, productName: string, revenue: number, coefficientVariation: number) => {
    // Важно: Теперь все элементы в массивах reasons, recommendations, risks, kpis
    // являются JSX-элементами (<span title="...">текст</span>).
    // Это обеспечивает поддержку подсказок при наведении.
    const analyses = {
      'AX': {
        icon: <Target className="w-5 h-5 text-green-600" />,
        title: 'Ключевые товары - постоянный контроль',
        priority: 'Критический',
        color: 'bg-green-50 border-green-200',
        reasons: [
          <span title="Высокая доля в выручке (группа A) означает, что этот товар является основным источником дохода для компании.">Высокая доля в выручке (группа A) - приносит основную прибыль</span>,
          <span title="Стабильный спрос (группа X) означает, что продажи этого товара предсказуемы и не имеют резких колебаний.">Стабильный спрос (группа X) - предсказуемые продажи</span>,
          <span title="Коэффициент вариации (Coefficient of Variation, CV) - это мера изменчивости данных. Низкий CV указывает на высокую стабильность спроса и минимальные риски нехватки/излишка.">Низкий коэффициент вариации - минимальные риски</span>
        ],
        recommendations: [
          <span title="Постоянное наличие на складе означает поддержание достаточного запаса товара, чтобы всегда удовлетворять спрос.">Обеспечить постоянное наличие на складе</span>,
          <span title="Мониторить конкурентов и рыночные цены - это отслеживать предложения конкурентов и текущие цены на рынке, чтобы оставаться конкурентоспособными.">Мониторить конкурентов и рыночные цены</span>,
          <span title="Инвестировать в качество и улучшение продукта - это постоянно работать над повышением качества товара и его характеристик.">Инвестировать в качество и улучшение продукта</span>,
          <span title="Долгосрочные отношения с поставщиками - это строить крепкие, доверительные связи с поставщиками для обеспечения стабильных и выгодных поставок.">Развивать долгосрочные отношения с поставщиками</span>
        ],
        risks: [
          <span title="Потеря поставщика критически скажется на бизнесе означает, что если основной поставщик перестанет поставлять товар, это приведет к серьезным проблемам с продажами и прибылью.">Потеря поставщика критически скажется на бизнесе</span>,
          <span title="Изменение потребительских предпочтений - это риск того, что покупатели могут перестать предпочитать данный товар из-за появления новых тенденций или продуктов.">Изменение потребительских предпочтений</span>,
          <span title="Конкуренты с лучшим предложением - это риск того, что новые или существующие конкуренты предложат более привлекательные товары или условия.">Появление конкурентов с лучшим предложением</span>
        ],
        kpis: [
          <span title="Уровень запасов: желаемый процент наличия товара на складе для удовлетворения спроса.">Уровень запасов: не менее 95%</span>,
          <span title="Время выполнения заказа: максимальное время от момента заказа до его доставки клиенту.">Время выполнения заказа: максимум 24 часа</span>,
          <span title="Удовлетворенность клиентов: процент клиентов, довольных продуктом или услугой.">Удовлетворенность клиентов: выше 90%</span>,
          <span title="Целевая выручка: плановый объем дохода от продаж.">Целевая выручка: ${(revenue * 1.1).toLocaleString('ru-RU')} ₽</span>
        ]
      },
      'AY': {
        icon: <Clock className="w-5 h-5 text-yellow-600" />,
        title: 'Важные товары - сезонное планирование',
        priority: revenue > 40000 ? 'Высокий' : 'Высокий',
        color: 'bg-yellow-50 border-yellow-200',
        reasons: [
          <span title="Высокая доля в выручке (группа A) — товар приносит значительный доход, но продажи имеют сезонный характер.">Высокая доля в выручке, но сезонный характер спроса</span>,
          <span title="Коэффициент вариации (Coefficient of Variation, CV) указывает на периодичность — CV выше, чем у стабильных товаров, но не настолько хаотичен, что позволяет выявить сезонные пики и спады.">Коэффициент вариации указывает на периодичность</span>,
          <span title="Точное прогнозирование и планирование — для минимизации рисков переизбытка или дефицита необходимо очень точно предсказывать спрос и планировать закупки.">Требует точного прогнозирования и планирования</span>
        ],
        recommendations: [
          <span title="Детальный план сезонных закупок — разработать чёткий график закупок и поставок, ориентированный на пики и спады сезонного спроса.">Создать детальный план сезонных закупок</span>,
          <span title="Анализировать исторические данные для прогнозов — использовать данные прошлых лет для выявления сезонных закономерностей и более точного предсказания будущих продаж.">Анализировать исторические данные для прогнозов</span>,
          <span title="Маркетинговые кампании под сезоны — проводить рекламные акции и мероприятия, синхронизированные с началом и окончанием сезона продаж.">Разработать маркетинговые кампании под сезоны</span>,
          <span title="Альтернативные каналы сбыта — искать другие способы реализации товара в межсезонье, чтобы избежать затоваривания (например, оптовые продажи, другие рынки).">Подготовить альтернативные каналы сбыта</span>
        ],
        risks: [
          <span title="Избыточные запасы в межсезонье — риск накопления большого количества товара на складе вне сезона его активных продаж, что ведёт к затратам на хранение и потерям.">Избыточные запасы в межсезонье</span>,
          <span title="Недостаток товара в пиковый период — риск упущенных продаж и недовольства клиентов из-за нехватки товара в моменты максимального спроса.">Недостаток товара в пиковый период</span>,
          <span title="Изменение сезонных трендов — риск того, что привычные сезонные колебания спроса могут измениться из-за внешних факторов (мода, погода, новые технологии).">Изменение сезонных трендов</span>
        ],
        kpis: [
          <span title="Точность прогноза: процент, насколько фактические продажи соответствуют прогнозируемым.">Точность прогноза: выше 85%</span>,
          <span title="Оборачиваемость запасов: скорость, с которой товар продается и заменяется новыми запасами.">Оборачиваемость запасов: оптимальная для сезона</span>,
          <span title="Потери от просрочки: процент товара, который становится непригодным к продаже из-за истечения срока годности.">Потери от просрочки: менее 5%</span>,
          <span title="Снижение вариации: цель по уменьшению колебаний спроса.">Снижение вариации: с ${coefficientVariation.toFixed(1)}% до ${(coefficientVariation * 0.8).toFixed(1)}%</span>
        ]
      },
      'AZ': {
        icon: <AlertTriangle className="w-5 h-5 text-red-600" />,
        title: revenue > 60000 ? 'Критические проблемные товары - срочный анализ' :
          revenue > 30000 ? 'Контрольные проблемные товары - детальный анализ' :
            'Условно-стабильные товары - мониторинг',
        priority: revenue > 60000 ? 'Критический' : revenue > 30000 ? 'Высокий' : 'Средний',
        color: revenue > 60000 ? 'bg-red-50 border-red-200' :
          revenue > 30000 ? 'bg-orange-50 border-orange-200' :
            'bg-yellow-50 border-yellow-200',
        reasons: [
          <span title="Высокая доля в выручке означает, что товар приносит значительный доход, но нерегулярный спрос делает продажи непредсказуемыми.">Высокая доля в выручке, но нерегулярный спрос</span>,
          <span title="Высокий коэффициент вариации (Coefficient of Variation, CV) указывает на значительную нестабильность спроса, что создает риски переизбытка или дефицита.">Высокий коэффициент вариации создает риски</span>,
          <span title="Сложность в планировании и управлении запасами возникает из-за непредсказуемости спроса, что усложняет прогнозирование и поддержание оптимального уровня запасов.">Сложность в планировании и управлении запасами</span>,
          revenue > 60000 ? <span title="Критический масштаб влияния на бизнес означает, что проблемы с этим товаром могут серьезно подорвать общие финансовые показатели и стабильность компании.">Критический масштаб влияния на бизнес</span> :
            revenue > 30000 ? <span title="Значительное влияние на финансовые показатели — проблемы с этим товаром могут заметно ухудшить финансовое состояние компании.">Значительное влияние на финансовые показатели</span> :
              <span title="Умеренное влияние на общую прибыльность — этот товар оказывает не самое большое, но ощутимое влияние на прибыль компании.">Умеренное влияние на общую прибыльность</span>
        ],
        recommendations: [
          <span title="Глубокий анализ причин нестабильности — необходимо выяснить основные факторы, вызывающие нерегулярность спроса (например, внешние тренды, действия конкурентов, внутренние ошибки).">Провести глубокий анализ причин нестабильности</span>,
          <span title="Поведение клиентов и факторы спроса — понять, кто, когда и почему покупает товар, а также какие внешние и внутренние факторы влияют на его продажи.">Изучить поведение клиентов и факторы спроса</span>,
          <span title="Сегментация клиентской базы — разделить клиентов на группы по их покупательскому поведению, чтобы разработать более целенаправленные стратегии.">Рассмотреть сегментацию клиентской базы</span>,
          <span title="Гибкая система поставок — создать систему, которая позволяет быстро адаптироваться к изменениям спроса, минимизируя риски излишков или нехватки.">Разработать гибкую систему поставок</span>,
          revenue > 60000 ? <span title="Отдельная команда для управления товаром — выделить специальную группу специалистов, которая будет заниматься исключительно этим товаром из-за его критической важности и сложности.">Создать отдельную команду для управления товаром</span> :
            <span title="Ответственный менеджер — закрепить за этим товаром конкретного сотрудника, отвечающего за его показатели и управление.">Назначить ответственного менеджера</span>
        ],
        risks: [
          <span title="Высокие затраты на хранение — если спрос непредсказуем, могут возникнуть излишки товара, что приведет к значительным расходам на складское хранение.">Высокие затраты на хранение</span>,
          <span title="Потери от неликвидных остатков — убытки, возникающие, когда товар долго лежит на складе, устаревает, портится и не может быть продан по полной цене или списывается.">Потери от неликвидных остатков</span>,
          <span title="Сложность в планировании денежных потоков — непредсказуемые продажи затрудняют прогнозирование поступлений и расходов, что может привести к финансовой нестабильности.">Сложность в планировании денежных потоков</span>,
          revenue > 60000 ? <span title="Критическое влияние на общую прибыльность компании — проблемы с этим товаром могут привести к значительному снижению общей прибыли компании.">Критическое влияние на общую прибыльность компании</span> :
            <span title="Значительные финансовые потери — существенные убытки, которые могут возникнуть из-за неправильного управления этим товаром.">Значительные финансовые потери</span>
        ],
        kpis: [
          <span title="Снижение коэффициента вариации: цель по уменьшению колебаний спроса.">Снижение коэффициента вариации: с ${coefficientVariation.toFixed(1)}% до ${(coefficientVariation * 0.7).toFixed(1)}%</span>,
          <span title="Улучшение точности прогноза: цель по повышению точности прогнозирования спроса.">Улучшение точности прогноза: до ${revenue > 60000 ? '80%' : '70%'}</span>,
          <span title="Сокращение неликвидных остатков: цель по уменьшению количества товаров, которые нельзя продать.">Сокращение неликвидных остатков: на ${revenue > 60000 ? '40%' : '30%'}</span>,
          <span title="Целевая выручка: плановый объем дохода от продаж.">Целевая выручка: ${(revenue * 0.95).toLocaleString('ru-RU')} ₽ (стабилизация)</span>
        ]
      },
      'BX': {
        icon: <TrendingUp className="w-5 h-5 text-blue-600" />,
        title: 'Стабильные товары - регулярный контроль',
        priority: 'Средний',
        color: 'bg-blue-50 border-blue-200',
        reasons: [
          <span title="Средняя доля в выручке означает, что товар приносит умеренный доход со стабильным спросом.">Средняя доля в выручке со стабильным спросом</span>,
          <span title="Предсказуемые продажи облегчают планирование — стабильность спроса позволяет легко прогнозировать будущие продажи и эффективно управлять запасами.">Предсказуемые продажи облегчают планирование</span>,
          <span title="Хороший баланс между прибыльностью и стабильностью — товар достаточно прибылен и при этом не создает больших рисков благодаря стабильному спросу.">Хороший баланс между прибыльностью и стабильностью</span>
        ],
        recommendations: [
          <span title="Оптимизировать уровни запасов — найти идеальный баланс между наличием товара и затратами на его хранение, чтобы избежать излишков и дефицита.">Оптимизировать уровни запасов</span>,
          <span title="Автоматизировать процессы заказа — использовать программное обеспечение для автоматического формирования заказов на пополнение запасов, что снижает трудозатраты и ошибки.">Автоматизировать процессы заказа</span>,
          <span title="Искать возможности для увеличения маржи — анализировать способы повышения прибыли от продажи этого товара, например, через переговоры с поставщиками или небольшое повышение цен.">Искать возможности для увеличения маржи</span>,
          <span title="Рост продаж — искать новые каналы сбыта или маркетинговые стратегии для увеличения объемов продаж этого товара.">Рассмотреть возможности роста продаж</span>
        ],
        risks: [
          <span title="Постепенное снижение доли рынка — риск того, что товар может постепенно терять свою конкурентоспособность и долю на рынке.">Постепенное снижение доли рынка</span>,
          <span title="Более эффективные аналоги — риск того, что конкуренты выпустят аналогичные товары, которые будут превосходить ваш по цене или качеству.">Появление более эффективных аналогов</span>,
          <span title="Изменение потребительских предпочтений — риск, что вкусы и потребности покупателей могут измениться, и спрос на ваш товар упадет.">Изменение потребительских предпочтений</span>
        ],
        kpis: [
          <span title="Уровень обслуживания: процент выполненных заказов без задержек или проблем.">Уровень обслуживания: 90-95%</span>,
          <span title="Оборачиваемость: количество раз, сколько товар продается и заменяется новыми запасами за год.">Оборачиваемость: 6-8 раз в год</span>,
          <span title="Рост продаж: ежегодное увеличение объемов продаж.">Рост продаж: 5-10% в год</span>,
          <span title="Целевая выручка: плановый объем дохода от продаж.">Целевая выручка: ${(revenue * 1.07).toLocaleString('ru-RU')} ₽</span>
        ]
      },
      'BY': {
        icon: <Clock className="w-5 h-5 text-orange-600" />,
        title: 'Сезонные товары - планирование запасов',
        priority: 'Средний',
        color: 'bg-orange-50 border-orange-200',
        reasons: [
          <span title="Средняя прибыльность означает, что товар приносит умеренный доход с сезонными колебаниями — его продажи сильно зависят от сезона.">Средняя прибыльность с сезонными колебаниями</span>,
          <span title="Планирование под сезонные пики — для эффективного управления необходимо заранее планировать закупки и запасы к периодам высокого спроса.">Требует планирования под сезонные пики</span>,
          <span title="Возможности для оптимизации затрат — есть потенциал для снижения расходов, связанных с хранением и управлением запасами.">Возможности для оптимизации затрат</span>
        ],
        recommendations: [
          <span title="Сезонные модели планирования — разработать специальные модели прогнозирования и планирования, учитывающие сезонность спроса.">Создать сезонные модели планирования</span>,
          <span title="Оптимизировать складские площади — эффективно использовать складское пространство, чтобы минимизировать затраты на хранение товара в межсезонье.">Оптимизировать складские площади</span>,
          <span title="Межсезонные продажи — искать способы стимулирования спроса на товар вне его основного сезона (например, скидки, новые применения товара).">Развивать межсезонные продажи</span>,
          <span title="Новые рынки сбыта — изучать возможности продажи товара на других рынках или в других регионах, где сезонность может отличаться.">Искать новые рынки сбыта</span>
        ],
        risks: [
          <span title="Затоваривание в межсезонье — риск накопления излишков товара на складе после окончания пикового сезона, что приводит к затратам и потерям.">Затоваривание в межсезонье</span>,
          <span title="Упущенные продажи в пиковый период — риск того, что не хватит товара для удовлетворения спроса в сезон, что приведет к потере прибыли.">Упущенные продажи в пиковый период</span>,
          <span title="Высокие затраты на хранение — из-за сезонных колебаний могут возникать периоды, когда товар долго лежит на складе, увеличивая расходы на его содержание.">Высокие затраты на хранение</span>
        ],
        kpis: [
          <span title="Сезонная точность прогноза: насколько хорошо прогнозы соответствуют фактическим продажам в сезон.">Сезонная точность прогноза: 80%</span>,
          <span title="Уровень запасов в межсезонье: объем запасов вне пикового сезона.">Уровень запасов в межсезонье: минимальный</span>,
          <span title="Покрытие пикового спроса: процент удовлетворенного спроса в периоды максимальных продаж.">Покрытие пикового спроса: 95%</span>,
          <span title="Снижение вариации: цель по уменьшению колебаний спроса.">Снижение вариации: до ${(coefficientVariation * 0.85).toFixed(1)}%</span>
        ]
      },
      'BZ': {
        icon: <AlertTriangle className="w-5 h-5 text-purple-600" />,
        title: 'Нестабильные товары - минимальные запасы',
        priority: 'Низкий',
        color: 'bg-purple-50 border-purple-200',
        reasons: [
          <span title="Средняя прибыльность означает, что товар приносит умеренный доход с высокой нестабильностью — его продажи очень непредсказуемы.">Средняя прибыльность с высокой нестабильностью</span>,
          <span title="Сложность прогнозирования увеличивает риски — крайне трудно предсказать спрос, что ведет к высоким рискам нехватки или излишка товара.">Сложность прогнозирования увеличивает риски</span>,
          <span title="Особый подход к управлению — из-за непредсказуемости, для этого товара нужны специальные стратегии контроля и планирования.">Требует особого подхода к управлению</span>
        ],
        recommendations: [
          <span title="Минимизировать уровни запасов — держать на складе как можно меньше этого товара, чтобы снизить риски и затраты.">Минимизировать уровни запасов</span>,
          <span title="Система 'точно в срок' (Just-In-Time) — заказывать и получать товар только тогда, когда он нужен для продажи, без создания больших запасов.">Использовать систему "точно в срок"</span>,
          <span title="Быстрые каналы поставок — иметь возможность получать товар очень быстро в случае внезапного спроса.">Развивать быстрые каналы поставок</span>,
          <span title="Отказ от товара — если риски и затраты на управление слишком высоки, стоит подумать о прекращении продажи этого товара.">Рассмотреть возможность отказа от товара</span>
        ],
        risks: [
          <span title="Высокие затраты на управление — непредсказуемость спроса требует больших усилий и ресурсов для контроля и планирования.">Высокие затраты на управление</span>,
          <span title="Потери от неликвидности — риск того, что товар будет долго лежать на складе, потеряет актуальность и его придется продавать со скидкой или списывать.">Потери от неликвидности</span>,
          <span title="Сложность в обслуживании клиентов — из-за непредсказуемости поставок может быть трудно обеспечить постоянное наличие товара для клиентов.">Сложность в обслуживании клиентов</span>
        ],
        kpis: [
          <span title="Минимальный уровень запасов: цель по поддержанию запасов на самом низком возможном уровне.">Минимальный уровень запасов</span>,
          <span title="Быстрота реакции на спрос: время, за которое компания может отреагировать на изменение спроса.">Быстрота реакции на спрос: 48 часов</span>,
          <span title="Рентабельность: отношение прибыли к выручке.">Рентабельность: положительная</span>,
          <span title="Стабилизация вариации: цель по уменьшению колебаний спроса.">Стабилизация вариации: ниже ${(coefficientVariation * 0.9).toFixed(1)}%</span>
        ]
      },
      'CX': {
        icon: <Target className="w-5 h-5 text-gray-600" />,
        title: 'Стабильные товары - автоматизация',
        priority: 'Низкий',
        color: 'bg-gray-50 border-gray-200',
        reasons: [
          <span title="Низкая доля в выручке означает, что товар приносит небольшой доход, но стабильный спрос — его продажи предсказуемы.">Низкая доля в выручке, но стабильный спрос</span>,
          <span title="Предсказуемость позволяет автоматизировать процессы — благодаря стабильности спроса можно настроить автоматические системы для заказа и управления этим товаром.">Предсказуемость позволяет автоматизировать процессы</span>,
          <span title="Минимальные требования к управлению — товар не требует постоянного контроля и значительных ресурсов для управления.">Минимальные требования к управлению</span>
        ],
        recommendations: [
          <span title="Полная автоматизация заказов — настроить систему, которая автоматически формирует и отправляет заказы на пополнение этого товара без участия человека.">Полная автоматизация заказов</span>,
          <span title="Оптимизация затрат на обслуживание — искать способы снизить расходы, связанные с хранением, обработкой и продажей этого товара.">Оптимизация затрат на обслуживание</span>,
          <span title="Аутсорсинг — передать часть или все функции по управлению этим товаром сторонней компании (например, логистическому оператору).">Рассмотреть аутсорсинг</span>,
          <span title="Минимизировать административные расходы — сократить бюрократию и ручные операции, связанные с этим товаром.">Минимизировать административные расходы</span>
        ],
        risks: [
          <span title="Потеря контроля над процессом — риск, что при полной автоматизации можно упустить из виду важные детали или проблемы, если не будет достаточного мониторинга.">Потеря контроля над процессом</span>,
          <span title="Сбои в автоматизации — риск ошибок или отказов в автоматизированных системах, что может привести к проблемам с поставками или запасами.">Возможные сбои в автоматизации</span>,
          <span title="Снижение качества обслуживания — если автоматизация приведет к снижению гибкости, это может негативно сказаться на способности удовлетворять потребности клиентов.">Снижение качества обслуживания</span>
        ],
        kpis: [
          <span title="Автоматизация заказов: процент заказов, обрабатываемых автоматически.">Автоматизация заказов: 100%</span>,
          <span title="Затраты на обслуживание: общие расходы на поддержку товара.">Затраты на обслуживание: минимальные</span>,
          <span title="Уровень сервиса: качество обслуживания клиентов.">Уровень сервиса: базовый</span>,
          <span title="Поддержание выручки: цель по сохранению текущего объема дохода.">Поддержание выручки: ${revenue.toLocaleString('ru-RU')} ₽</span>
        ]
      },
      'CY': {
        icon: <Clock className="w-5 h-5 text-indigo-600" />,
        title: 'Сезонные товары - точечные закупки',
        priority: 'Низкий',
        color: 'bg-indigo-50 border-indigo-200',
        reasons: [
          <span title="Низкая прибыльность означает, что товар приносит небольшой доход с сезонными колебаниями — его продажи сильно зависят от сезона.">Низкая прибыльность с сезонными колебаниями</span>,
          <span title="Ограниченный потенциал роста — маловероятно, что продажи этого товара значительно вырастут в будущем.">Ограниченный потенциал роста</span>,
          <span title="Минимальные инвестиции — нет смысла вкладывать много денег в продвижение или запасы этого товара.">Требует минимальных инвестиций</span>
        ],
        recommendations: [
          <span title="Закупки только под конкретные заказы — не закупать товар впрок, а только тогда, когда есть подтвержденный заказ от клиента.">Закупки только под конкретные заказы</span>,
          <span title="Минимизировать складские запасы — держать на складе крайне мало или совсем не держать этот товар, чтобы избежать затрат на хранение.">Минимизировать складские запасы</span>,
          <span title="Дропшиппинг — продавать товар без собственного склада, отправляя заказы напрямую поставщику для доставки клиенту.">Рассмотреть работу с дропшиппингом</span>,
          <span title="Целесообразность продолжения продаж — проанализировать, стоит ли вообще продолжать продавать этот товар, если он приносит мало пользы и много проблем.">Оценить целесообразность продолжения продаж</span>
        ],
        risks: [
          <span title="Потеря клиентов из-за отсутствия товара — риск, что клиенты уйдут к конкурентам, если товара не будет в наличии, когда он им нужен.">Потеря клиентов из-за отсутствия товара</span>,
          <span title="Упущенные возможности в пиковые периоды — риск не получить максимальную прибыль, если товар не будет доступен в моменты высокого спроса.">Упущенные возможности в пиковые периоды</span>,
          <span title="Высокие относительные затраты — несмотря на низкий объем, затраты на управление и логистику этого товара могут быть высоки по отношению к его доходу.">Высокие относительные затраты</span>
        ],
        kpis: [
          <span title="Запасы: стратегия управления запасами, при которой товар закупается только после получения заказа.">Запасы: только под заказ</span>,
          <span title="Время выполнения: срок от заказа до получения товара клиентом.">Время выполнения: до 7 дней</span>,
          <span title="Прибыльность: положительное значение означает, что товар приносит прибыль.">Прибыльность: положительная</span>,
          <span title="Минимальная выручка: порог дохода, который должен быть достигнут.">Минимальная выручка: ${(revenue * 0.8).toLocaleString('ru-RU')} ₽</span>
        ]
      },
      'CZ': {
        icon: <AlertTriangle className="w-5 h-5 text-red-800" />,
        title: 'Товары на выбытие - минимизация',
        priority: 'Критический (на выбытие)',
        color: 'bg-red-100 border-red-300',
        reasons: [
          <span title="Низкая прибыльность означает, что товар приносит мало денег и нестабильный спрос — его продажи непредсказуемы, что делает его невыгодным.">Низкая прибыльность и нестабильный спрос</span>,
          <span title="Высокие риски и затраты на управление — из-за нестабильности и низкой прибыльности, этот товар требует слишком много ресурсов и несет большие риски.">Высокие риски и затраты на управление</span>,
          <span title="Отвлекает ресурсы от более важных товаров — время, деньги и усилия, потраченные на этот товар, могли бы быть использованы для более прибыльных и стратегически важных товаров.">Отвлекает ресурсы от более важных товаров</span>
        ],
        recommendations: [
          <span title="Прекратить активные продажи — остановить рекламные кампассии и усилия по продвижению этого товара.">Прекратить активные продажи</span>,
          <span title="Распродать остатки со скидкой — продать весь имеющийся запас товара по сниженной цене, чтобы избавиться от него.">Распродать остатки со скидкой</span>,
          <span title="Не возобновлять закупки — прекратить все новые заказы этого товара у поставщиков.">Не возобновлять закупки</span>,
          <span title="Перенаправить ресурсы на группы A и B — освободившиеся ресурсы (время сотрудников, бюджет) направить на управление и развитие более важных и прибыльных товаров.">Перенаправить ресурсы на группы A и B</span>
        ],
        risks: [
          <span title="Потери от списания остатков — убытки, возникающие, если товар не удается продать и его приходится полностью списывать.">Потери от списания остатков</span>,
          <span title="Недовольство постоянных клиентов — некоторые клиенты могут быть недовольны, если их любимый товар перестанет быть доступен.">Недовольство постоянных клиентов</span>,
          <span title="Контрактные обязательства — могут быть контракты с поставщиками или клиентами, которые усложняют быстрый вывод товара.">Возможные контрактные обязательства</span>
        ],
        kpis: [
          <span title="Срок вывода: время, необходимое для полного прекращения продаж товара.">Срок вывода: 3-6 месяцев</span>,
          <span title="Минимизация потерь при выводе: цель по уменьшению убытков при прекращении продаж товара.">Минимизация потерь при выводе</span>,
          <span title="Перераспределение ресурсов: направление ресурсов на более приоритетные товары.">Перераспределение ресурсов</span>,
          <span title="Целевая ликвидация: целевая выручка от продажи остатков товара.">Целевая ликвидация: до ${(revenue * 0.3).toLocaleString('ru-RU')} ₽</span>
        ]
      }
    };

    // Запасной вариант, если combinedCategory не найден
    return analyses[combinedCategory as keyof typeof analyses] || {
      icon: <AlertTriangle className="w-5 h-5 text-gray-600" />,
      title: 'Требует дополнительного анализа',
      priority: 'Неопределен',
      color: 'bg-gray-50 border-gray-200',
      reasons: [
        <span title="Нестандартная комбинация категорий означает, что текущее соотношение выручки (ABC) и стабильности спроса (XYZ) не соответствует ни одной из заранее определённых категорий товаров.">Нестандартная комбинация категорий</span>
      ],
      recommendations: [
        <span title="Провести детальный анализ — это значит вручную изучить данные по данному товару, чтобы понять его особенности и определить его истинную категорию и стратегию управления.">Провести детальный анализ</span>
      ],
      risks: [
        <span title="Неопределенные риски означают, что без детального анализа невозможно предсказать потенциальные проблемы или угрозы для этого товара.">Неопределенные риски</span>
      ],
      kpis: [
        <span title="Требуется определение KPI — для этого товара пока не установлены ключевые показатели эффективности, которые помогли бы отслеживать его успех или проблемные моменты.">Требуется определение KPI</span>
      ]
    };
  };

  // Компонент для отображения стратегии анализа
  const renderAnalysisContent = (analysis: ReturnType<typeof getStrategyAnalysis>) => {
    if (!analysis || !analysis.title) return <p>Выберите товар для анализа.</p>;

    return (
      <div className={`${analysis.color} p-4 rounded-lg border flex flex-col gap-4 mb-4`}>
        <div className="flex items-center gap-2 text-gray-800">
          {analysis.icon}
          <h4 className="font-semibold text-lg">{analysis.title}</h4>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <h5 className="font-medium text-gray-700 mb-2">Приоритет: <span className={`font-semibold ${analysis.priority === 'Критический' ? 'text-red-600' : analysis.priority === 'Высокий' ? 'text-orange-600' : 'text-blue-600'}`}>{analysis.priority}</span></h5>
            <p className="text-gray-700 mb-2">Выручка: {analytics.abcxyzAnalysis.find(item => item.combined_category === analysis.title.split(' ')[0] && item.product_name === (expandedStrategy || ''))?.revenue.toLocaleString('ru-RU')} ₽</p> {/* Здесь может быть баг если product_name не совпадает с title части */}
            <h5 className="font-medium text-gray-700 mb-2">Основные причины:</h5>
            <ul className="list-none space-y-1">
              {analysis.reasons.map((reason, idx) => (
                <li key={idx} className="flex items-start gap-1 text-gray-700">
                  <span className="text-blue-600 mt-1">•</span>
                  {/* Здесь reason уже является JSX-элементом <span>, так что оборачивать его не нужно */}
                  {reason}
                </li>
              ))}
            </ul>
          </div>
          <div>
            <h5 className="font-medium text-gray-700 mb-2">Рекомендации:</h5>
            <ul className="list-none space-y-1">
              {analysis.recommendations.map((rec, idx) => (
                <li key={idx} className="flex items-start gap-1 text-gray-700">
                  <span className="text-green-600 mt-1">✓</span>
                  {rec}
                </li>
              ))}
            </ul>
          </div>
          <div>
            <h5 className="font-medium text-gray-700 mb-2">Основные риски:</h5>
            <ul className="list-none space-y-1">
              {analysis.risks.map((risk, idx) => (
                <li key={idx} className="flex items-start gap-1 text-gray-700">
                  <span className="text-red-600 mt-1">!</span>
                  {risk}
                </li>
              ))}
            </ul>
            <h5 className="font-medium text-gray-700 mt-4 mb-2">KPI для контроля:</h5>
            <ul className="list-none space-y-1">
              {analysis.kpis.map((kpi, idx) => (
                <li key={idx} className="flex items-start gap-1 text-gray-700">
                  <span className="text-purple-600 mt-1">📈</span>
                  {kpi}
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    );
  };


  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <h1 className="text-3xl font-bold text-gray-900 mb-8">Панель аналитики продаж</h1>

      {/* Обзор по месяцам */}
      <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Обзор по месяцам</h2>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={analytics.monthlyTrend}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="month" />
            <YAxis yAxisId="left" orientation="left" stroke="#8884d8" />
            <YAxis yAxisId="right" orientation="right" stroke="#82ca9d" />
            <Tooltip />
            <Legend />
            <Line yAxisId="left" type="monotone" dataKey="sales" name="Количество продаж" stroke="#8884d8" activeDot={{ r: 8 }} />
            <Line yAxisId="right" type="monotone" dataKey="revenue" name="Выручка (руб.)" stroke="#82ca9d" activeDot={{ r: 8 }} />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Расширенная аналитика */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-lg font-semibold text-gray-900">Расширенная аналитика</h3>
          <button
            onClick={exportToExcel}
            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <Download className="w-4 h-4" />
            Экспорт всех анализов
          </button>
        </div>

        <div className="flex flex-wrap gap-2 mb-6">
          {[
            { key: 'abc', label: 'ABC анализ' },
            { key: 'xyz', label: 'XYZ анализ' },
            { key: 'abcxyz', label: 'ABC-XYZ анализ' },
            { key: 'factor', label: 'Факторный анализ' },
            { key: 'structural', label: 'Структурный анализ' }
          ].map(tab => (
            <button
              key={tab.key}
              onClick={() => setActiveAnalysis(tab.key as any)}
              className={`px-4 py-2 rounded-lg transition-colors ${
                activeAnalysis === tab.key
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>

        {activeAnalysis === 'abc' && (
          <div className="bg-gray-50 p-4 rounded-lg">
            <h4 className="text-lg font-medium text-gray-800 mb-4">Распределение товаров по ABC категориям</h4>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={analytics.abcAnalysis.slice(0, 10)}> {/* Отображаем топ-10 для наглядности */}
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="product_name" angle={-45} textAnchor="end" height={80} interval={0} />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="revenue" name="Выручка (руб.)" fill="#8884d8">
                  {analytics.abcAnalysis.slice(0, 10).map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
            <div className="mt-4 overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b border-gray-200">Товар</th>
                    <th className="py-3 px-6 border-b border-gray-200">Выручка (руб.)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Доля (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Накоп. доля (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Категория</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {analytics.abcAnalysis.map((item, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">{item.product_name}</td>
                      <td className="py-3 px-6">{item.revenue.toLocaleString('ru-RU')}</td>
                      <td className="py-3 px-6">{item.percentage.toFixed(1)}</td>
                      <td className="py-3 px-6">{item.cumulative_percentage.toFixed(1)}</td>
                      <td className="py-3 px-6 font-medium">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.category === 'A' ? 'bg-green-100 text-green-800' :
                          item.category === 'B' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>{item.category}</span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeAnalysis === 'xyz' && (
          <div className="bg-gray-50 p-4 rounded-lg">
            <h4 className="text-lg font-medium text-gray-800 mb-4">Распределение товаров по XYZ категориям</h4>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={analytics.xyzAnalysis.slice(0, 10)}> {/* Отображаем топ-10 для наглядности */}
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="product_name" angle={-45} textAnchor="end" height={80} interval={0} />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="coefficient_variation" name="Коэффициент вариации (%)" fill="#82ca9d">
                  {analytics.xyzAnalysis.slice(0, 10).map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
            <div className="mt-4 overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b border-gray-200">Товар</th>
                    <th className="py-3 px-6 border-b border-gray-200">Коэф. вариации (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Категория</th>
                    <th className="py-3 px-6 border-b border-gray-200">Стабильность спроса</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {analytics.xyzAnalysis.map((item, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">{item.product_name}</td>
                      <td className="py-3 px-6">{item.coefficient_variation.toFixed(1)}</td>
                      <td className="py-3 px-6 font-medium">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.category === 'X' ? 'bg-blue-100 text-blue-800' :
                          item.category === 'Y' ? 'bg-purple-100 text-purple-800' :
                          'bg-orange-100 text-orange-800'
                        }`}>{item.category}</span>
                      </td>
                      <td className="py-3 px-6">{item.demand_stability}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeAnalysis === 'abcxyz' && (
          <div className="bg-gray-50 p-4 rounded-lg">
            <h4 className="text-lg font-medium text-gray-800 mb-4">ABC-XYZ анализ и стратегии управления</h4>

            {/* Фильтры */}
            <div className="flex flex-wrap gap-4 mb-4 items-end">
              <div>
                <label htmlFor="abcFilter" className="block text-sm font-medium text-gray-700">Категория ABC:</label>
                <select
                  id="abcFilter"
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  value={abcxyzFilters.abcCategory}
                  onChange={(e) => setAbcxyzFilters({ ...abcxyzFilters, abcCategory: e.target.value })}
                >
                  <option value="">Все</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                </select>
              </div>
              <div>
                <label htmlFor="xyzFilter" className="block text-sm font-medium text-gray-700">Категория XYZ:</label>
                <select
                  id="xyzFilter"
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  value={abcxyzFilters.xyzCategory}
                  onChange={(e) => setAbcxyzFilters({ ...abcxyzFilters, xyzCategory: e.target.value })}
                >
                  <option value="">Все</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                </select>
              </div>
              <div>
                <label htmlFor="priorityFilter" className="block text-sm font-medium text-gray-700">Приоритет:</label>
                <select
                  id="priorityFilter"
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  value={abcxyzFilters.priority}
                  onChange={(e) => setAbcxyzFilters({ ...abcxyzFilters, priority: e.target.value })}
                >
                  <option value="">Все</option>
                  <option value="Критический">Критический</option>
                  <option value="Высокий">Высокий</option>
                  <option value="Средний">Средний</option>
                  <option value="Низкий">Низкий</option>
                  <option value="Неопределен">Неопределен</option>
                  <option value="Критический (на выбытие)">Критический (на выбытие)</option>
                </select>
              </div>
              <div>
                <label htmlFor="combinedCategoryFilter" className="block text-sm font-medium text-gray-700">Комбинированная категория:</label>
                <select
                  id="combinedCategoryFilter"
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  value={abcxyzFilters.combinedCategory}
                  onChange={(e) => setAbcxyzFilters({ ...abcxyzFilters, combinedCategory: e.target.value })}
                >
                  <option value="">Все</option>
                  {Array.from(new Set(analytics.abcxyzAnalysis.map(item => item.combined_category))).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>
            </div>

            <div className="overflow-x-auto mb-4">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b border-gray-200">Товар</th>
                    <th className="py-3 px-6 border-b border-gray-200">ABC</th>
                    <th className="py-3 px-6 border-b border-gray-200">XYZ</th>
                    <th className="py-3 px-6 border-b border-gray-200">Комбинация</th>
                    <th className="py-3 px-6 border-b border-gray-200">Стратегия</th>
                    <th className="py-3 px-6 border-b border-gray-200">Приоритет</th>
                    <th className="py-3 px-6 border-b border-gray-200">Выручка (руб.)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Коэф. вариации (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Действия</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {analytics.abcxyzAnalysis
                    .filter(item =>
                      (abcxyzFilters.abcCategory === '' || item.abc_category === abcxyzFilters.abcCategory) &&
                      (abcxyzFilters.xyzCategory === '' || item.xyz_category === abcxyzFilters.xyzCategory) &&
                      (abcxyzFilters.priority === '' || item.priority === abcxyzFilters.priority) &&
                      (abcxyzFilters.combinedCategory === '' || item.combined_category === abcxyzFilters.combinedCategory)
                    )
                    .map((item, index) => (
                      <React.Fragment key={index}>
                        <tr className="border-b border-gray-200 hover:bg-gray-50">
                          <td className="py-3 px-6">{item.product_name}</td>
                          <td className="py-3 px-6">{item.abc_category}</td>
                          <td className="py-3 px-6">{item.xyz_category}</td>
                          <td className="py-3 px-6 font-medium">{item.combined_category}</td>
                          <td className="py-3 px-6">{item.strategy}</td>
                          <td className="py-3 px-6">
                            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                              item.priority === 'Критический' ? 'bg-red-100 text-red-800' :
                              item.priority === 'Высокий' ? 'bg-orange-100 text-orange-800' :
                              item.priority === 'Средний' ? 'bg-blue-100 text-blue-800' :
                              item.priority === 'Низкий' ? 'bg-gray-100 text-gray-800' :
                              'bg-purple-100 text-purple-800'
                            }`}>{item.priority}</span>
                          </td>
                          <td className="py-3 px-6">{item.revenue.toLocaleString('ru-RU')}</td>
                          <td className="py-3 px-6">{item.coefficient_variation.toFixed(1)}</td>
                          <td className="py-3 px-6">
                            <button
                              onClick={() => setExpandedStrategy(expandedStrategy === item.product_name ? null : item.product_name)}
                              className="text-blue-600 hover:text-blue-800 focus:outline-none"
                            >
                              {expandedStrategy === item.product_name ? <ChevronDown className="w-5 h-5" /> : <ChevronRight className="w-5 h-5" />}
                            </button>
                          </td>
                        </tr>
                        {expandedStrategy === item.product_name && (
                          <tr>
                            <td colSpan={9} className="p-4 bg-blue-50 border-t border-blue-200">
                              {renderAnalysisContent(getStrategyAnalysis(item.combined_category, item.product_name, item.revenue, item.coefficient_variation))}
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeAnalysis === 'factor' && (
          <div className="bg-gray-50 p-4 rounded-lg">
            <h4 className="text-lg font-medium text-gray-800 mb-4">Факторный анализ</h4>
            <ResponsiveContainer width="100%" height={300}>
              <ComposedChart
                layout="vertical"
                data={analytics.factorAnalysis.sort((a, b) => b.impact - a.impact)} // Сортировка по влиянию
                margin={{ top: 20, right: 20, bottom: 20, left: 20 }}
              >
                <CartesianGrid stroke="#f5f5f5" />
                <XAxis type="number" />
                <YAxis dataKey="factor" type="category" width={100} />
                <Tooltip />
                <Legend />
                <Bar dataKey="impact" name="Влияние (%)" barSize={20} fill="#413ea0">
                  {analytics.factorAnalysis.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.trend === 'positive' ? '#27AE60' : entry.trend === 'negative' ? '#EF4444' : '#F59E0B'} />
                  ))}
                </Bar>
              </ComposedChart>
            </ResponsiveContainer>
            <div className="mt-4 overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b border-gray-200">Фактор</th>
                    <th className="py-3 px-6 border-b border-gray-200">Влияние (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Описание</th>
                    <th className="py-3 px-6 border-b border-gray-200">Тренд</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {analytics.factorAnalysis.map((item, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">{item.factor}</td>
                      <td className="py-3 px-6">{item.impact.toFixed(1)}</td>
                      <td className="py-3 px-6">{item.description}</td>
                      <td className="py-3 px-6">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.trend === 'positive' ? 'bg-green-100 text-green-800' :
                          item.trend === 'negative' ? 'bg-red-100 text-red-800' :
                          'bg-yellow-100 text-yellow-800'
                        }`}>{item.trend === 'positive' ? 'Положительный' : item.trend === 'negative' ? 'Отрицательный' : 'Нейтральный'}</span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeAnalysis === 'structural' && (
          <div className="bg-gray-50 p-4 rounded-lg">
            <h4 className="text-lg font-medium text-gray-800 mb-4">Структурный анализ</h4>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {/* По категориям товаров */}
              <div>
                <h5 className="font-semibold text-gray-700 mb-2">По категориям товаров</h5>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie
                      data={analytics.structuralAnalysis.byCategory}
                      dataKey="value"
                      nameKey="category"
                      cx="50%"
                      cy="50%"
                      outerRadius={80}
                      fill="#8884d8"
                      label
                    >
                      {analytics.structuralAnalysis.byCategory.map((entry, index) => (
                        <Cell key={`cell-category-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
                <div className="mt-2 text-sm text-gray-700">
                  {analytics.structuralAnalysis.byCategory.map((item, idx) => (
                    <p key={idx}>{item.category}: {item.value.toLocaleString('ru-RU')} ₽ ({item.percentage.toFixed(1)}%)</p>
                  ))}
                </div>
              </div>

              {/* По регионам */}
              <div>
                <h5 className="font-semibold text-gray-700 mb-2">По регионам</h5>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie
                      data={analytics.structuralAnalysis.byRegion}
                      dataKey="value"
                      nameKey="category"
                      cx="50%"
                      cy="50%"
                      outerRadius={80}
                      fill="#82ca9d"
                      label
                    >
                      {analytics.structuralAnalysis.byRegion.map((entry, index) => (
                        <Cell key={`cell-region-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
                <div className="mt-2 text-sm text-gray-700">
                  {analytics.structuralAnalysis.byRegion.map((item, idx) => (
                    <p key={idx}>{item.category}: {item.value.toLocaleString('ru-RU')} ₽ ({item.percentage.toFixed(1)}%)</p>
                  ))}
                </div>
              </div>

              {/* По каналам продаж */}
              <div>
                <h5 className="font-semibold text-gray-700 mb-2">По каналам продаж</h5>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie
                      data={analytics.structuralAnalysis.byChannel}
                      dataKey="value"
                      nameKey="category"
                      cx="50%"
                      cy="50%"
                      outerRadius={80}
                      fill="#ffc658"
                      label
                    >
                      {analytics.structuralAnalysis.byChannel.map((entry, index) => (
                        <Cell key={`cell-channel-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
                <div className="mt-2 text-sm text-gray-700">
                  {analytics.structuralAnalysis.byChannel.map((item, idx) => (
                    <p key={idx}>{item.category}: {item.value.toLocaleString('ru-RU')} ₽ ({item.percentage.toFixed(1)}%)</p>
                  ))}
                </div>
              </div>
            </div>
            <div className="mt-6 overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b border-gray-200">Тип</th>
                    <th className="py-3 px-6 border-b border-gray-200">Название</th>
                    <th className="py-3 px-6 border-b border-gray-200">Значение (руб.)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Доля (%)</th>
                    <th className="py-3 px-6 border-b border-gray-200">Изменение (%)</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {analytics.structuralAnalysis.byCategory.map((item, index) => (
                    <tr key={`cat-${index}`} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">Категория</td>
                      <td className="py-3 px-6">{item.category}</td>
                      <td className="py-3 px-6">{item.value.toLocaleString('ru-RU')}</td>
                      <td className="py-3 px-6">{item.percentage.toFixed(1)}</td>
                      <td className="py-3 px-6">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.change > 0 ? 'bg-green-100 text-green-800' :
                          item.change < 0 ? 'bg-red-100 text-red-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>{item.change.toFixed(1)}</span>
                      </td>
                    </tr>
                  ))}
                  {analytics.structuralAnalysis.byRegion.map((item, index) => (
                    <tr key={`reg-${index}`} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">Регион</td>
                      <td className="py-3 px-6">{item.category}</td>
                      <td className="py-3 px-6">{item.value.toLocaleString('ru-RU')}</td>
                      <td className="py-3 px-6">{item.percentage.toFixed(1)}</td>
                      <td className="py-3 px-6">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.change > 0 ? 'bg-green-100 text-green-800' :
                          item.change < 0 ? 'bg-red-100 text-red-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>{item.change.toFixed(1)}</span>
                      </td>
                    </tr>
                  ))}
                  {analytics.structuralAnalysis.byChannel.map((item, index) => (
                    <tr key={`chan-${index}`} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">Канал</td>
                      <td className="py-3 px-6">{item.category}</td>
                      <td className="py-3 px-6">{item.value.toLocaleString('ru-RU')}</td>
                      <td className="py-3 px-6">{item.percentage.toFixed(1)}</td>
                      <td className="py-3 px-6">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          item.change > 0 ? 'bg-green-100 text-green-800' :
                          item.change < 0 ? 'bg-red-100 text-red-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>{item.change.toFixed(1)}</span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Charts;